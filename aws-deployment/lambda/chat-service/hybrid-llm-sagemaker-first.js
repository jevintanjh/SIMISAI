/**
 * Hybrid LLM Service - SageMaker SEA-LION First Priority
 * Optimized to showcase SEA-LION as primary AI with fast OpenAI fallback
 * Priority: SageMaker SEA-LION ‚Üí OpenAI GPT-4 ‚Üí Enhanced Local
 */

const { SageMakerRuntimeClient, InvokeEndpointCommand } = require('@aws-sdk/client-sagemaker-runtime');
const https = require('https');

// Initialize AWS SDK v3 client with optimized settings for fast SageMaker
const sagemakerClient = new SageMakerRuntimeClient({ 
    region: 'us-east-1',
    requestHandler: {
        requestTimeout: 20000, // 20 second timeout for SageMaker (generous but reasonable)
        connectionTimeout: 3000 // Fast connection timeout
    }
});

exports.handler = async (event) => {
    const startTime = Date.now();
    console.log('Lambda started - SageMaker SEA-LION priority mode');
    
    try {
        const body = JSON.parse(event.body);
        const { messages } = body;
        
        // Extract the last user message
        const lastMessage = messages[messages.length - 1];
        const userInput = lastMessage.content;
        
        console.log('Processing input:', userInput);
        
        // Detect language for optimized prompts
        const language = detectLanguageImproved(userInput);
        console.log('Detected language:', language);
        
        let response;
        let providerInfo;
        let sagemakerSuccess = false;
        
        // **PRIORITY 1: SEA-LION SageMaker (Primary for demo)**
        try {
            console.log('üöÄ Attempting SEA-LION SageMaker first...');
            
            // Fast SageMaker attempt with timeout protection
            const sagemakerResponse = await Promise.race([
                callSageMakerEndpointOptimized(userInput, language),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('SageMaker taking too long')), 18000) // 18 second timeout
                )
            ]);
            
            response = sagemakerResponse;
            providerInfo = {
                provider: 'SEA-LION LLM (27B)',
                status: 'Primary AI Service',
                note: 'üåè ASEAN-specialized AI model - Custom trained for Southeast Asian medical guidance',
                detectedLanguage: language,
                responseTime: `${Date.now() - startTime}ms`,
                model: 'SEA-LION 27B Parameters',
                region: 'ASEAN Optimized'
            };
            sagemakerSuccess = true;
            console.log('‚úÖ SEA-LION success in', Date.now() - startTime, 'ms');
            
        } catch (sagemakerError) {
            console.log('‚ö†Ô∏è SEA-LION unavailable:', sagemakerError.message);
            
            // **PRIORITY 2: OpenAI GPT-4 (Fast fallback)**
            if (process.env.OPENAI_API_KEY) {
                try {
                    console.log('üîÑ Falling back to OpenAI GPT-4...');
                    const openaiResponse = await Promise.race([
                        callOpenAIOptimized(userInput, language),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('OpenAI timeout')), 10000) // 10 second OpenAI timeout
                        )
                    ]);
                    
                    response = openaiResponse;
                    providerInfo = {
                        provider: 'OpenAI GPT-4',
                        status: 'Backup AI Service',
                        note: 'üîÑ SEA-LION temporarily loading - using OpenAI for fast response',
                        detectedLanguage: language,
                        responseTime: `${Date.now() - startTime}ms`,
                        fallbackReason: 'SageMaker endpoint warming up or high demand'
                    };
                    console.log('‚úÖ OpenAI fallback success in', Date.now() - startTime, 'ms');
                    
                } catch (openaiError) {
                    console.log('‚ö†Ô∏è OpenAI also failed:', openaiError.message);
                    throw new Error('Both AI services unavailable');
                }
            } else {
                throw new Error('No OpenAI fallback configured');
            }
        }
        
        // **PRIORITY 3: Enhanced local responses (emergency fallback)**
        if (!response) {
            console.log('üõü Using enhanced local fallback...');
            response = generateImprovedResponse(userInput, language);
            providerInfo = {
                provider: 'SIMISAI Enhanced Local',
                status: 'Emergency Fallback',
                note: 'üõü All AI services temporarily unavailable - using enhanced medical device database',
                detectedLanguage: language,
                responseTime: `${Date.now() - startTime}ms`
            };
        }
        
        const totalTime = Date.now() - startTime;
        console.log(`‚úÖ Response ready from ${providerInfo.provider} in ${totalTime}ms`);
        
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
            },
            body: JSON.stringify({
                response: response,
                provider: providerInfo,
                requestCount: 1,
                sagemakerReady: sagemakerSuccess,
                debug: `SageMaker-first architecture - ${totalTime}ms total time`,
                architecture: 'SEA-LION (Primary) ‚Üí OpenAI (Fallback) ‚Üí Local (Emergency)'
            })
        };
        
    } catch (error) {
        console.error('üí• Critical error:', error);
        
        // Ultra-fast emergency response
        const emergencyResponse = generateEmergencyResponse();
        
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                response: emergencyResponse,
                provider: {
                    provider: 'Emergency Response System',
                    status: 'System Recovery',
                    note: 'üö® All AI services experiencing issues - providing basic medical device guidance',
                    responseTime: `${Date.now() - startTime}ms`
                },
                requestCount: 1,
                sagemakerReady: false,
                debug: `Emergency mode: ${error.message}`,
                architecture: 'Emergency fallback active'
            })
        };
    }
};

/**
 * Optimized SageMaker call for SEA-LION with better prompts
 */
async function callSageMakerEndpointOptimized(userInput, language) {
    try {
        const prompt = createSeaLionOptimizedPrompt(userInput, language);
        
        console.log('üì° Calling SEA-LION with optimized prompt...');
        
        const command = new InvokeEndpointCommand({
            EndpointName: 'simisai-sealion-realtime-endpoint',
            ContentType: 'application/json',
            Body: JSON.stringify({
                inputs: prompt,
                parameters: {
                    max_new_tokens: 300, // Balanced for quality and speed
                    temperature: 0.7,
                    top_p: 0.9,
                    do_sample: true,
                    repetition_penalty: 1.1 // Prevent repetition
                }
            })
        });
        
        const result = await sagemakerClient.send(command);
        const response = JSON.parse(new TextDecoder().decode(result.Body));
        
        // Extract and clean response
        let generatedText = response.generated_text || response[0]?.generated_text || response.text || response.output;
        
        // Clean up the response (remove prompt if included)
        if (generatedText && generatedText.includes(prompt)) {
            generatedText = generatedText.replace(prompt, '').trim();
        }
        
        // Ensure we have a good response
        if (!generatedText || generatedText.length < 10) {
            throw new Error('SEA-LION returned insufficient response');
        }
        
        console.log('üéØ SEA-LION response length:', generatedText.length);
        return generatedText;
        
    } catch (error) {
        console.error('‚ùå SageMaker endpoint error:', error);
        throw new Error(`SEA-LION endpoint failed: ${error.message}`);
    }
}

/**
 * Fast OpenAI fallback with medical focus
 */
async function callOpenAIOptimized(userInput, language) {
    return new Promise((resolve, reject) => {
        const prompt = createOpenAIOptimizedPrompt(userInput, language);
        
        const payload = JSON.stringify({
            model: "gpt-4o-mini", // Fast model for quick fallback
            messages: [
                {
                    role: "system",
                    content: "You are SIMISAI, a medical device assistant. Provide clear, safe instructions for medical device usage. Be concise but comprehensive."
                },
                {
                    role: "user",
                    content: prompt
                }
            ],
            max_tokens: 250, // Optimized for speed
            temperature: 0.7
        });
        
        const options = {
            hostname: 'api.openai.com',
            path: '/v1/chat/completions',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                'Content-Length': Buffer.byteLength(payload)
            },
            timeout: 8000 // Fast timeout for fallback
        };
        
        const req = https.request(options, (res) => {
            let data = '';
            
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                try {
                    const response = JSON.parse(data);
                    const content = response.choices?.[0]?.message?.content;
                    
                    if (content) {
                        resolve(content);
                    } else {
                        reject(new Error('Invalid OpenAI response format'));
                    }
                } catch (parseError) {
                    reject(new Error('Failed to parse OpenAI response'));
                }
            });
        });
        
        req.on('error', (error) => {
            reject(error);
        });
        
        req.on('timeout', () => {
            req.destroy();
            reject(new Error('OpenAI request timed out'));
        });
        
        req.write(payload);
        req.end();
    });
}

/**
 * Create optimized prompts for SEA-LION (ASEAN-focused)
 */
function createSeaLionOptimizedPrompt(userInput, language) {
    const prompts = {
        'English': `You are SIMISAI, an AI medical device assistant specialized in Southeast Asian healthcare. A user asks: "${userInput}"

Please provide clear, step-by-step instructions for using medical devices safely. Focus on practical guidance that's easy to follow.

Response:`,
        'Chinese': `‰Ω†ÊòØSIMISAIÔºå‰∏ìÈó®ÊúçÂä°‰∫é‰∏úÂçó‰∫öÂåªÁñó‰øùÂÅ•ÁöÑAIÂä©Êâã„ÄÇÁî®Êà∑ËØ¢ÈóÆÔºö"${userInput}"

ËØ∑Êèê‰æõÊ∏ÖÊô∞ÁöÑÈÄêÊ≠•ÂåªÁñóËÆæÂ§á‰ΩøÁî®ÊåáÂØºÔºåÊ≥®ÈáçÂÆâÂÖ®ÂíåÂÆûÁî®ÊÄß„ÄÇ

ÂõûÂ§çÔºö`,
        'Indonesian': `Anda adalah SIMISAI, asisten AI perangkat medis yang mengkhususkan diri dalam layanan kesehatan Asia Tenggara. Pengguna bertanya: "${userInput}"

Berikan instruksi langkah demi langkah yang jelas untuk menggunakan perangkat medis dengan aman.

Jawaban:`,
        'Thai': `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ SIMISAI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÉ‡∏ï‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°: "${userInput}"

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

‡∏ï‡∏≠‡∏ö:`,
        'Vietnamese': `B·∫°n l√† SIMISAI, tr·ª£ l√Ω AI thi·∫øt b·ªã y t·∫ø chuy√™n v·ªÅ chƒÉm s√≥c s·ª©c kh·ªèe ƒê√¥ng Nam √Å. Ng∆∞·ªùi d√πng h·ªèi: "${userInput}"

H√£y cung c·∫•p h∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc r√µ r√†ng ƒë·ªÉ s·ª≠ d·ª•ng thi·∫øt b·ªã y t·∫ø m·ªôt c√°ch an to√†n.

Tr·∫£ l·ªùi:`
    };
    
    return prompts[language] || prompts['English'];
}

/**
 * Create focused OpenAI prompts
 */
function createOpenAIOptimizedPrompt(userInput, language) {
    return `As SIMISAI medical device assistant, help with: "${userInput}". Provide step-by-step guidance in ${language}. Be clear and concise.`;
}

/**
 * Improved language detection
 */
function detectLanguageImproved(text) {
    // Chinese characters (including Traditional and Simplified)
    if (/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/.test(text)) return 'Chinese';
    
    // Thai script
    if (/[\u0e00-\u0e7f]/.test(text)) return 'Thai';
    
    // Vietnamese (Latin with diacritics)
    if (/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text)) return 'Vietnamese';
    
    // Indonesian keywords
    if (/\b(halo|selamat|saya|anda|bantuan|termometer|tekanan|darah|bagaimana|menggunakan|instruksi)\b/i.test(text)) return 'Indonesian';
    
    // Malay keywords  
    if (/\b(hello|selamat|saya|anda|bantuan|termometer|tekanan|darah|bagaimana|guna|panduan)\b/i.test(text)) return 'Malay';
    
    // Filipino/Tagalog keywords
    if (/\b(kumusta|hello|ako|ikaw|tulong|termometro|presyon|dugo|paano|gamitin)\b/i.test(text)) return 'Filipino';
    
    // Tamil script
    if (/[\u0b80-\u0bff]/.test(text)) return 'Tamil';
    
    // Other Southeast Asian scripts
    if (/[\u1780-\u17ff]/.test(text)) return 'Khmer'; // Cambodia
    if (/[\u0e80-\u0eff]/.test(text)) return 'Lao';    // Laos
    if (/[\u1000-\u109f]/.test(text)) return 'Burmese'; // Myanmar
    
    return 'English';
}

/**
 * Enhanced local responses with comprehensive medical device guidance
 */
function generateImprovedResponse(input, language) {
    const responses = {
        'English': {
            greeting: "Hello! I'm SIMISAI, your AI-powered medical device assistant specializing in ASEAN healthcare. What device do you need help with?",
            thermometer: "**Digital Thermometer Instructions:**\n\nüìã **Preparation:**\n1. Clean thermometer tip with alcohol wipe\n2. Turn on device and wait for ready signal\n\nüå°Ô∏è **Taking Temperature:**\n3. **Oral**: Place under tongue, close mouth\n4. **Underarm**: Place in armpit, hold arm down\n5. Wait for beep signal (30-60 seconds)\n6. Read temperature on display\n\nüìä **Normal Ranges:**\n‚Ä¢ Oral: 98.6¬∞F (37¬∞C) ¬± 0.5¬∞F\n‚Ä¢ Underarm: 97.6¬∞F (36.4¬∞C) ¬± 0.5¬∞F\n\nüö® **When to Contact Doctor:**\n‚Ä¢ Fever over 100.4¬∞F (38¬∞C) for adults\n‚Ä¢ Any fever in infants under 3 months",
            
            bloodPressure: "**Blood Pressure Monitor Guide:**\n\nü™ë **Preparation (5 minutes):**\n1. Sit quietly, feet flat on floor\n2. Rest arm on table at heart level\n3. Avoid caffeine/smoking 30 min before\n\nü©∫ **Taking Measurement:**\n4. Wrap cuff snugly around upper arm (1 inch above elbow)\n5. Ensure cuff is at heart level\n6. Press START button\n7. Remain completely still and silent\n8. Wait for automatic deflation and reading\n\nüìä **Understanding Results:**\n‚Ä¢ **Normal**: Less than 120/80 mmHg\n‚Ä¢ **Elevated**: 120-129 (systolic) and less than 80 (diastolic)\n‚Ä¢ **High BP Stage 1**: 130-139/80-89 mmHg\n‚Ä¢ **High BP Stage 2**: 140/90 mmHg or higher\n\n‚ö†Ô∏è **Consult Doctor If:** Consistently above 140/90 mmHg",
            
            glucose: "**Blood Glucose Meter Instructions:**\n\nüßº **Preparation:**\n1. Wash hands thoroughly with soap and warm water\n2. Dry hands completely\n3. Gather supplies: meter, test strips, lancet device\n\nü©∏ **Testing Process:**\n4. Insert test strip into meter\n5. Use lancet to prick side of fingertip\n6. Gently squeeze to form blood drop\n7. Touch blood drop to test strip (don't smear)\n8. Wait 5-10 seconds for result\n\nüìä **Target Levels (mg/dL):**\n‚Ä¢ **Fasting**: 80-130 mg/dL\n‚Ä¢ **Before meals**: 80-130 mg/dL\n‚Ä¢ **2 hours after meals**: Less than 180 mg/dL\n‚Ä¢ **Bedtime**: 100-140 mg/dL\n\nüö® **Important**: Follow your doctor's specific target ranges",
            
            nebulizer: "**Nebulizer Usage Guide:**\n\nüßΩ **Setup:**\n1. Wash hands and clean nebulizer cup\n2. Assemble nebulizer according to instructions\n3. Connect tubing to air compressor\n\nüíä **Medication:**\n4. Add prescribed medication to nebulizer cup\n5. Do not mix medications unless directed\n6. Attach mouthpiece or mask\n\nüí® **Treatment:**\n7. Sit upright in comfortable position\n8. Place mouthpiece in mouth, seal lips around it\n9. Turn on compressor\n10. Breathe slowly and deeply through mouth\n11. Continue until medication is gone (10-15 minutes)\n\nüßº **After Use:**\n12. Clean nebulizer cup and mouthpiece with warm soapy water\n13. Air dry all parts",
            
            general: "I can provide detailed guidance for these medical devices:\n\nüå°Ô∏è **Digital Thermometers** - Accurate temperature measurement\nü©∏ **Blood Pressure Monitors** - Heart health monitoring\nüç¨ **Blood Glucose Meters** - Diabetes management\nüí® **Nebulizers** - Respiratory treatment delivery\nü´Å **Pulse Oximeters** - Blood oxygen monitoring\nüíâ **Insulin Pens** - Diabetes medication delivery\nü©π **Wound Care Devices** - Proper wound management\n\n**ASEAN Healthcare Focus**: Specialized guidance for Southeast Asian medical practices and climate considerations.\n\nWhat specific device would you like detailed instructions for?"
        },
        
        'Chinese': {
            greeting: "ÊÇ®Â•ΩÔºÅÊàëÊòØSIMISAIÔºå‰∏ìÈó®ÊúçÂä°‰∫é‰∏úÁõüÂåªÁñó‰øùÂÅ•ÁöÑAIÂåªÁñóËÆæÂ§áÂä©Êâã„ÄÇËØ∑ÈóÆÊÇ®ÈúÄË¶ÅÂì™ÁßçËÆæÂ§áÁöÑÂ∏ÆÂä©Ôºü",
            thermometer: "**Êï∞Â≠ó‰ΩìÊ∏©ËÆ°‰ΩøÁî®ÊåáÂçóÔºö**\n\nüìã **ÂáÜÂ§áÂ∑•‰ΩúÔºö**\n1. Áî®ÈÖíÁ≤æÊ£âÁêÉÊ∏ÖÊ¥Å‰ΩìÊ∏©ËÆ°Â§¥ÈÉ®\n2. ÂºÄÊú∫Á≠âÂæÖÂáÜÂ§áÂ∞±Áª™‰ø°Âè∑\n\nüå°Ô∏è **ÊµãÈáè‰ΩìÊ∏©Ôºö**\n3. **Âè£Ê∏©**ÔºöÊîæÁΩÆËàå‰∏ãÔºåÈó≠Âò¥\n4. **ËÖãÊ∏©**ÔºöÊîæÁΩÆËÖã‰∏ãÔºåÂ§πÁ¥ßÊâãËáÇ\n5. Á≠âÂæÖËúÇÈ∏£‰ø°Âè∑Ôºà30-60ÁßíÔºâ\n6. ËØªÂèñÊòæÁ§∫Ê∏©Â∫¶\n\nüìä **Ê≠£Â∏∏ËåÉÂõ¥Ôºö**\n‚Ä¢ Âè£Ê∏©Ôºö37¬∞C ¬± 0.3¬∞C\n‚Ä¢ ËÖãÊ∏©Ôºö36.4¬∞C ¬± 0.3¬∞C\n\nüö® **Â∞±ÂåªÊåáÊ†áÔºö**\n‚Ä¢ Êàê‰∫∫ÂèëÁÉ≠Ë∂ÖËøá38¬∞C\n‚Ä¢ 3‰∏™Êúà‰ª•‰∏ãÂ©¥ÂÑø‰ªª‰ΩïÂèëÁÉ≠",
            bloodPressure: "**Ë°ÄÂéãËÆ°‰ΩøÁî®ÊåáÂçóÔºö**\n\nü™ë **ÂáÜÂ§áÔºà5ÂàÜÈíüÔºâÔºö**\n1. ÂÆâÈùôÂùêÁùÄÔºåÂèåËÑöÂπ≥Êîæ\n2. ÊâãËáÇÊîæÊ°å‰∏ä‰∏éÂøÉËÑèÂêåÈ´ò\n3. ÊµãÈáèÂâç30ÂàÜÈíüÈÅøÂÖçÂíñÂï°Âõ†/Âê∏ÁÉü\n\nü©∫ **ÊµãÈáèËøáÁ®ãÔºö**\n4. Ë¢ñÂ∏¶Á¥ßË¥¥‰∏äËáÇÔºàËÇò‰∏ä1ÂØ∏Ôºâ\n5. Á°Æ‰øùË¢ñÂ∏¶‰∏éÂøÉËÑèÂêåÈ´ò\n6. ÊåâÂºÄÂßãÊåâÈíÆ\n7. ‰øùÊåÅÂÆåÂÖ®ÈùôÊ≠¢ÂíåÂÆâÈùô\n8. Á≠âÂæÖËá™Âä®ÊîæÊ∞îÂíåËØªÊï∞\n\nüìä **ÁªìÊûúÁêÜËß£Ôºö**\n‚Ä¢ **Ê≠£Â∏∏**Ôºö‰Ωé‰∫é120/80 mmHg\n‚Ä¢ **ÂÅèÈ´ò**Ôºö120-129ÔºàÊî∂Áº©ÂéãÔºâ‰∏î‰Ωé‰∫é80ÔºàËàíÂº†ÂéãÔºâ\n‚Ä¢ **È´òË°ÄÂéã1Êúü**Ôºö130-139/80-89 mmHg\n‚Ä¢ **È´òË°ÄÂéã2Êúü**Ôºö140/90 mmHgÊàñÊõ¥È´ò\n\n‚ö†Ô∏è **Â∞±ÂåªÊåáÊ†áÔºö** ÊåÅÁª≠È´ò‰∫é140/90 mmHg",
            general: "ÊàëÂèØ‰ª•‰∏∫Ëøô‰∫õÂåªÁñóËÆæÂ§áÊèê‰æõËØ¶ÁªÜÊåáÂØºÔºö\n\nüå°Ô∏è **Êï∞Â≠ó‰ΩìÊ∏©ËÆ°** - ÂáÜÁ°Æ‰ΩìÊ∏©ÊµãÈáè\nü©∏ **Ë°ÄÂéãËÆ°** - ÂøÉËÑèÂÅ•Â∫∑ÁõëÊµã\nüç¨ **Ë°ÄÁ≥ñ‰ª™** - Á≥ñÂ∞øÁóÖÁÆ°ÁêÜ\nüí® **ÈõæÂåñÂô®** - ÂëºÂê∏Ê≤ªÁñó\n\n**‰∏úÁõüÂåªÁñó‰∏ìÊ≥®**: ÈíàÂØπ‰∏úÂçó‰∫öÂåªÁñóÂÆûË∑µÂíåÊ∞îÂÄôËÄÉËôëÁöÑ‰∏ì‰∏öÊåáÂØº„ÄÇ\n\nËØ∑ÈóÆÊÇ®ÈúÄË¶ÅÂì™ÁßçÁâπÂÆöËÆæÂ§áÁöÑËØ¶ÁªÜËØ¥ÊòéÔºü"
        }
    };
    
    const langResponses = responses[language] || responses['English'];
    const inputLower = input.toLowerCase();
    
    // Smart device detection with multiple keywords
    if (/thermo|temp|fever|ÁÉ≠|‰ΩìÊ∏©|ÂèëÁÉß|‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥|nhi·ªát ƒë·ªô/i.test(inputLower)) return langResponses.thermometer;
    if (/blood.*pressure|bp|Ë°ÄÂéã|È´òË°ÄÂéã|ÈáèË°ÄÂéã|‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô|huy·∫øt √°p/i.test(inputLower)) return langResponses.bloodPressure;
    if (/glucose|sugar|diabetes|Ë°ÄÁ≥ñ|Á≥ñÂ∞øÁóÖ|‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô|ƒë∆∞·ªùng huy·∫øt/i.test(inputLower)) return langResponses.glucose;
    if (/nebulizer|inhaler|ÈõæÂåñ|Âê∏ÂÖ•|‡∏û‡πà‡∏ô‡∏¢‡∏≤|x√¥ng kh√≠/i.test(inputLower)) return langResponses.nebulizer;
    if (/hello|hi|‰Ω†Â•Ω|ÊÇ®Â•Ω|halo|‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|xin ch√†o|kumusta/i.test(inputLower)) return langResponses.greeting;
    
    return langResponses.general;
}

/**
 * Emergency response for critical failures
 */
function generateEmergencyResponse() {
    return "üö® **SIMISAI Emergency Mode Active**\n\nI'm experiencing technical difficulties but can provide basic medical device guidance:\n\n**Quick Device Help:**\n‚Ä¢ **Thermometer**: Clean ‚Üí Under tongue ‚Üí Wait for beep ‚Üí Read display\n‚Ä¢ **Blood Pressure**: Sit quietly ‚Üí Wrap cuff ‚Üí Press start ‚Üí Stay still\n‚Ä¢ **Glucose Meter**: Wash hands ‚Üí Insert strip ‚Üí Prick finger ‚Üí Apply blood\n\n**For urgent medical concerns, please contact your healthcare provider immediately.**\n\n*System will return to full AI capability shortly.*";
}